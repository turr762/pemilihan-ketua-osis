<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kartu Undangan Pemilihan Ketua OSIS</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f3f4f6; text-align: center; padding: 20px; }
    canvas { margin-top: 20px; border: 2px solid #444; max-width: 100%; display: none; }
    input, select, button { margin: 10px; padding: 10px; font-size: 16px; }
    .btn { background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 5px; }
    .btn:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h1>Kartu Undangan Pemilihan Ketua OSIS</h1>

  <input type="text" id="nama" placeholder="Masukkan Nama"><br>

  <select id="sebagai" onchange="updateRole()">
    <option value="">Sebagai...</option>
    <option value="Murid">Murid</option>
    <option value="Guru">Guru</option>
  </select><br>

  <div id="muridForm" style="display:none;">
    <select id="kelasUtama" onchange="updateSubkelas()">
      <option value="">Pilih Kelas</option>
      <option value="7">Kelas 7</option>
      <option value="8">Kelas 8</option>
      <option value="9">Kelas 9</option>
    </select><br>

    <select id="subkelas">
      <option value="">Pilih Subkelas</option>
    </select><br>
  </div>

  <div id="guruForm" style="display:none;">
    <select id="jabatan">
      <option value="">Pilih Jabatan</option>
      <option value="Guru Mapel">Guru Mapel</option>
      <option value="Wali Kelas">Wali Kelas</option>
      <option value="Kepala Sekolah">Kepala Sekolah</option>
      <option value="Tendik">Tendik</option>
    </select><br>
  </div>

  <button class="btn" id="buatBtn">Buat Kartu</button>
  <button class="btn" id="downloadBtn" style="display:none">Unduh Kartu</button>
  <br>
  <canvas id="canvas"></canvas>

  <script>
    // --- localStorage key untuk menyimpan logs ---
    const LOG_KEY = "kartu_logs_v1";

    function loadLogs() {
      return JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
    }

    function saveLogs(logs) {
      localStorage.setItem(LOG_KEY, JSON.stringify(logs));
    }

    // tambah log baru hanya jika belum ada nama yang sama persis
    function addLog(entry) {
      const logs = loadLogs();
      const duplikat = logs.find(l => l.name.toLowerCase().trim() === entry.name.toLowerCase().trim());
      if (duplikat) {
        alert(`Nama "${entry.name}" sudah pernah dibuat kartunya!`);
        return false; // jangan lanjut
      }
      logs.push(entry);
      saveLogs(logs);
      window.dispatchEvent(new CustomEvent('kartu_logs_updated', { detail: entry }));
      return true;
    }

    function nowISO() {
      return new Date().toISOString();
    }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const buatBtn = document.getElementById("buatBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    let templateImage = new Image();
    templateImage.crossOrigin = "anonymous";
    templateImage.src = "https://raw.githubusercontent.com/turr762/pemilihan-ketua-osis/refs/heads/main/siswa.jpg";
    templateImage.onload = () => {
      canvas.width = templateImage.width;
      canvas.height = templateImage.height;
      ctx.drawImage(templateImage, 0, 0);
    };

    function updateRole() {
      const role = document.getElementById("sebagai").value;
      document.getElementById("muridForm").style.display = role === "Murid" ? "block" : "none";
      document.getElementById("guruForm").style.display = role === "Guru" ? "block" : "none";
    }

    function updateSubkelas() {
      const kelasUtama = document.getElementById("kelasUtama").value;
      const subkelas = document.getElementById("subkelas");
      subkelas.innerHTML = "<option value=''>Pilih Subkelas</option>";
      let options = [];
      if (kelasUtama === "7") options = ["7A","7B","7C","7D","7E","7F","7G"];
      if (kelasUtama === "8") options = ["8A","8B","8C","8D","8E","8F","8G","8H"];
      if (kelasUtama === "9") options = ["9A","9B","9C","9D","9E","9F","9G"];
      options.forEach(opt => { const o = document.createElement("option"); o.value = opt; o.text = opt; subkelas.appendChild(o); });
    }

    function getBilik(subkelas) {
      const mapping = { A:"Bilik 1",B:"Bilik 2",C:"Bilik 3",D:"Bilik 4",E:"Bilik 5",F:"Bilik 6",G:"Bilik 7",H:"Bilik 1" };
      const huruf = subkelas.slice(-1);
      return mapping[huruf] || "Bilik Bebas";
    }

    async function drawCardToBlob({ nameText, roleText, keteranganText, bilikText }) {
      return new Promise((resolve) => {
        const fixedHeight = 1080;
        const scale = fixedHeight / templateImage.height;
        const fixedWidth = Math.round(templateImage.width * scale);
        canvas.width = fixedWidth;
        canvas.height = fixedHeight;

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(templateImage, 0, 0, fixedWidth, fixedHeight);

        ctx.fillStyle = "black";
        ctx.textAlign = "center";

        ctx.font = "bold 38px Arial";
        ctx.fillText(nameText, canvas.width / 2, canvas.height * 0.33);

        ctx.font = "bold 30px Arial";
        ctx.fillText("Sebagai " + roleText, canvas.width / 2, canvas.height * 0.37);

        ctx.font = "bold 32px Arial";
        ctx.fillText(keteranganText, canvas.width / 2, canvas.height * 0.40);

        ctx.font = "bold 32px Arial";
        ctx.fillText(bilikText, canvas.width / 2, canvas.height * 0.44);

        canvas.toBlob(blob => resolve(blob), "image/png", 1.0);
      });
    }

    buatBtn.addEventListener("click", async () => {
      const nama = document.getElementById("nama").value.trim();
      const role = document.getElementById("sebagai").value;
      if (!nama || !role) { alert("Isi nama dan pilih peran dulu!"); return; }

      let keterangan = "", bilik = "";
      if (role === "Murid") {
        const subkelas = document.getElementById("subkelas").value;
        if (!subkelas) { alert("Pilih subkelas dulu!"); return; }
        keterangan = "Kelas " + subkelas;
        bilik = getBilik(subkelas);
      } else {
        const jabatan = document.getElementById("jabatan").value;
        if (!jabatan) { alert("Pilih jabatan dulu!"); return; }
        keterangan = jabatan;
        bilik = "Bilik Bebas";
      }

      // cek duplikat sebelum generate
      const entry = { time: nowISO(), name: nama, role: role, keterangan: keterangan, bilik: bilik };
      const ok = addLog(entry);
      if (!ok) return; // stop kalau nama duplikat

      const blob = await drawCardToBlob({ nameText:nama, roleText:role, keteranganText:keterangan, bilikText:bilik });
      canvas.style.display = "block";
      document.getElementById("downloadBtn").style.display = "inline-block";

      const url = URL.createObjectURL(blob);
      document.getElementById("downloadBtn").onclick = () => {
        const a = document.createElement("a");
        a.href = url;
        a.download = `kartu_${nama.replace(/[^\w\s]/gi,'')}.png`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };
    });
  </script>
</body>
</html>
