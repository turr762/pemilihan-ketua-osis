<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kartu Undangan Pemilihan Ketua OSIS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      text-align: center;
      padding: 20px;
    }
    canvas {
      margin-top: 20px;
      border: 2px solid #444;
      max-width: 100%;
      display: none;
    }
    input, select, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
    .btn {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px;
    }
    .btn:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h1>Kartu Undangan Pemilihan Ketua OSIS</h1>

  <input type="text" id="nama" placeholder="Masukkan Nama"><br>

  <select id="sebagai" onchange="updateRole()">
    <option value="">Sebagai...</option>
    <option value="Murid">Murid</option>
    <option value="Guru">Guru</option>
  </select><br>

  <div id="muridForm" style="display:none;">
    <select id="kelasUtama" onchange="updateSubkelas()">
      <option value="">Pilih Kelas</option>
      <option value="7">Kelas 7</option>
      <option value="8">Kelas 8</option>
      <option value="9">Kelas 9</option>
    </select><br>

    <select id="subkelas">
      <option value="">Pilih Subkelas</option>
    </select><br>
  </div>

  <div id="guruForm" style="display:none;">
    <select id="jabatan">
      <option value="">Pilih Jabatan</option>
      <option value="Guru Mapel">Guru Mapel</option>
      <option value="Wali Kelas">Wali Kelas</option>
      <option value="Kepala Sekolah">Kepala Sekolah</option>
      <option value="Tendik">Tendik</option>
    </select><br>
  </div>

  <button class="btn" onclick="generateImage()">Buat Kartu</button>
  <button class="btn" id="downloadBtn" style="display:none" onclick="downloadImage()">Unduh Kartu</button>
  <canvas id="canvas"></canvas>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <script>
    // === Firebase Setup ===
    const firebaseConfig = {
      apiKey: "AIzaSyCTwIn2Ckl-tu6QTgW2X2kKz0ruy-bvErY",
      authDomain: "pemilihan-ketos-ecad9.firebaseapp.com",
      databaseURL: "https://pemilihan-ketos-ecad9-default-rtdb.firebaseio.com",
      projectId: "pemilihan-ketos-ecad9",
      storageBucket: "pemilihan-ketos-ecad9.firebasestorage.app",
      messagingSenderId: "347053662789",
      appId: "1:347053662789:web:cccd638e31fb3a2491792c",
      measurementId: "G-8G46RV8ZW0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Elemen Canvas & Template ===
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const templateImage = new Image();
    templateImage.crossOrigin = "anonymous";
    templateImage.src = "https://raw.githubusercontent.com/turr762/pemilihan-ketua-osis/refs/heads/main/siswa.jpg";
    templateImage.onload = () => {
      canvas.width = templateImage.width;
      canvas.height = templateImage.height;
    };

    // === Fungsi Form ===
    function updateRole() {
      const role = document.getElementById("sebagai").value;
      document.getElementById("muridForm").style.display = role === "Murid" ? "block" : "none";
      document.getElementById("guruForm").style.display = role === "Guru" ? "block" : "none";
    }

    function updateSubkelas() {
      const kelas = document.getElementById("kelasUtama").value;
      const subkelas = document.getElementById("subkelas");
      subkelas.innerHTML = "<option value=''>Pilih Subkelas</option>";
      let options = [];
      if (kelas === "7") options = ["7A","7B","7C","7D","7E","7F","7G"];
      if (kelas === "8") options = ["8A","8B","8C","8D","8E","8F","8G","8H"];
      if (kelas === "9") options = ["9A","9B","9C","9D","9E","9F","9G"];
      options.forEach(o => {
        const op = document.createElement("option");
        op.value = o;
        op.text = o;
        subkelas.appendChild(op);
      });
    }

    // === FUNGSI YANG DIUBAH (8H GACHA) ===
    function getBilik(subkelas) {
      const map = {
        A: "Bilik 1",
        B: "Bilik 2",
        C: "Bilik 3",
        D: "Bilik 4",
        E: "Bilik 5",
        F: "Bilik 6",
        G: "Bilik 7",
        H: "Bilik 1"
      };

      // Kalau kelasnya 8H → random bilik 1–7
      if (subkelas === "8H") {
        const randomNum = Math.floor(Math.random() * 7) + 1;
        return `Bilik ${randomNum}`;
      }

      return map[subkelas.slice(-1)] || "Bilik Bebas";
    }

    // === Generate Gambar & Simpan Data ===
    async function generateImage() {
      const nama = document.getElementById("nama").value.trim();
      const role = document.getElementById("sebagai").value;
      if (!nama || !role) return alert("Isi nama dan pilih peran dulu!");

      let keterangan = "", bilik = "";
      if (role === "Murid") {
        const subkelas = document.getElementById("subkelas").value;
        if (!subkelas) return alert("Pilih kelas dan subkelas!");
        keterangan = "Kelas " + subkelas;
        bilik = getBilik(subkelas);
      } else {
        const jabatan = document.getElementById("jabatan").value;
        if (!jabatan) return alert("Pilih jabatan!");
        keterangan = jabatan;
        bilik = "Bilik Bebas";
      }

      // === CEK NAMA SUDAH ADA (REALTIME DAN GLOBAL) ===
      const snapshot = await db.ref("tracker").once("value");
      const data = snapshot.val() || {};
      const exists = Object.values(data).some(e => e.nama.toLowerCase() === nama.toLowerCase());
      if (exists) {
        alert("Nama sudah terdaftar di sistem! Silakan gunakan nama lain.");
        return;
      }

      // Simpan data baru ke Firebase
      const waktu = new Date().toLocaleString("id-ID", {timeZone:"Asia/Jakarta"});
      await db.ref("tracker/" + Date.now()).set({ nama, sebagai: role, keterangan, bilik, waktu });

      // Gambar ke canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(templateImage, 0, 0);
      ctx.fillStyle = "black";
      ctx.textAlign = "center";
      ctx.font = "bold 38px Arial";
      ctx.fillText(nama, canvas.width / 2, canvas.height * 0.33);
      ctx.font = "bold 30px Arial";
      ctx.fillText("Sebagai " + role, canvas.width / 2, canvas.height * 0.37);
      ctx.font = "bold 32px Arial";
      ctx.fillText(keterangan, canvas.width / 2, canvas.height * 0.40);
      ctx.font = "bold 32px Arial";
      ctx.fillText(bilik, canvas.width / 2, canvas.height * 0.44);

      canvas.style.display = "block";
      document.getElementById("downloadBtn").style.display = "inline-block";
    }

    function downloadImage() {
      const link = document.createElement("a");
      link.download = "kartu_undangan.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }
  </script>
</body>
</html>