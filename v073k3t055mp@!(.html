<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, set, push, remove, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTwIn2Ckl-tu6QTgW2X2kKz0ruy-bvErY",
    authDomain: "pemilihan-ketos-ecad9.firebaseapp.com",
    databaseURL: "https://pemilihan-ketos-ecad9-default-rtdb.firebaseio.com",
    projectId: "pemilihan-ketos-ecad9",
    storageBucket: "pemilihan-ketos-ecad9.firebasestorage.app",
    messagingSenderId: "347053662789",
    appId: "1:347053662789:web:cccd638e31fb3a2491792c",
    measurementId: "G-8G46RV8ZW0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const KANDIDAT = [
    "Kandidat 1","Kandidat 2","Kandidat 3","Kandidat 4",
    "Kandidat 5","Kandidat 6","Kandidat 7","Kandidat 8"
  ];

  let currentUser = null;
  let photos = [];
  let imageUnlocked = false;

  const photosRef = ref(db, "photos");
  onValue(photosRef, snap => {
    const val = snap.val();
    photos = Array.isArray(val) ? val.slice(0, KANDIDAT.length) : [];
    if (!Array.isArray(val) && val && typeof val === 'object') {
      photos = [];
      for (let i=0;i<KANDIDAT.length;i++){
        photos[i] = val[i] || "";
      }
    }
    for (let i = 0; i < KANDIDAT.length; i++) if (typeof photos[i] === 'undefined') photos[i] = "";
    if (document.getElementById("voteBox").style.display !== "none") renderCandidates();
  });

  function renderCandidates() {
    const container = document.getElementById("candidateContainer");
    container.innerHTML = "";
    KANDIDAT.forEach((name, i) => {
      const card = document.createElement("div");
      card.className = "candidate";
      const img = document.createElement("img");
      img.src = photos[i] || `https://via.placeholder.com/300.png?text=No+Foto`;
      img.alt = name;
      img.loading = "lazy";
      img.addEventListener('click', () => showFullscreenImage(img.src, name));

      const meta = document.createElement("div");
      meta.className = "meta";

      const title = document.createElement("h3");
      title.textContent = name;

      const controls = document.createElement("div");
      controls.className = "controls";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.className = "fileInput";
      fileInput.disabled = !imageUnlocked;
      fileInput.addEventListener("change", (ev) => handleUpload(ev, i));

      const delBtn = document.createElement("button");
      delBtn.textContent = "Hapus Foto";
      delBtn.className = "small";
      delBtn.disabled = !imageUnlocked;
      delBtn.addEventListener("click", () => handleDeletePhoto(i));

      const pilihBtn = document.createElement("button");
      pilihBtn.textContent = "Pilih";
      pilihBtn.className = "small";
      pilihBtn.style.background = "#4caf50";
      pilihBtn.style.color = "#fff";
      pilihBtn.addEventListener("click", () => vote(i));

      controls.appendChild(pilihBtn);
      controls.appendChild(fileInput);
      controls.appendChild(delBtn);
      meta.appendChild(title);
      meta.appendChild(controls);

      card.appendChild(img);
      card.appendChild(meta);
      container.appendChild(card);
    });
  }

  function showFullscreenImage(src, title) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.9)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';
    overlay.addEventListener('click', () => document.body.removeChild(overlay));

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '95%';
    img.style.maxHeight = '95%';
    img.style.borderRadius = '8px';
    img.alt = title;

    overlay.appendChild(img);
    document.body.appendChild(overlay);
  }

  async function handleUpload(ev, index) {
    const file = ev.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert("Pilih file gambar."); return; }
    const reader = new FileReader();
    reader.onload = async (e) => {
      const dataUrl = e.target.result;
      await set(ref(db, `photos/${index}`), dataUrl);
    };
    reader.readAsDataURL(file);
  }

  async function handleDeletePhoto(index) {
    if (!confirm("Hapus foto kandidat ini?")) return;
    await remove(ref(db, `photos/${index}`));
  }

  async function vote(index) {
    if (!currentUser) { alert("Isi nama & pilih kelas dulu."); return; }
    const vref = push(ref(db, "votes"));
    await set(vref, {
      nama: currentUser.nama,
      kelas: currentUser.kelas,
      subkelas: currentUser.subkelas,
      kandidat: KANDIDAT[index],
      waktu: Date.now()
    });
    const pv = push(ref(db, "voters"));
    await set(pv, { nama: currentUser.nama, kelas: currentUser.kelas, subkelas: currentUser.subkelas, waktu: Date.now() });
    alert("Terima kasih — suara sudah tercatat.");
    location.reload();
  }

  const subkelas = ["A","B","C","D","E","F","G","H"];
  const kelasSubSelect = document.getElementById("kelasSub");
  const kelasTingkatSelect = document.getElementById("kelasTingkat");

  kelasTingkatSelect.addEventListener('change', () => {
    const tingkat = kelasTingkatSelect.value;
    kelasSubSelect.innerHTML = '<option value="">Pilih Subkelas / Wali Kelas</option>';
    if (!tingkat) { kelasSubSelect.disabled = true; return; }

    if (tingkat === "Guru") {
      ["Wali Kelas", "Guru Mapel"].forEach(nama => {
        const opt = document.createElement('option');
        opt.value = nama;
        opt.textContent = nama;
        kelasSubSelect.appendChild(opt);
      });
    } else {
      subkelas.forEach(s => {
        const opt = document.createElement('option');
        opt.value = `${tingkat}${s}`;
        opt.textContent = `${tingkat}${s}`;
        kelasSubSelect.appendChild(opt);
      });
    }

    kelasSubSelect.disabled = false;
  });

  // 🔒 CEK NAMA SUDAH PERNAH DIPAKAI ATAU BELUM
  document.getElementById("startBtn").addEventListener('click', async () => {
    const nama = document.getElementById("nama").value.trim();
    const kelas = kelasTingkatSelect.value;
    const subkelasValue = kelasSubSelect.value;
    if (!nama || !kelas || !subkelasValue) { alert("Isi nama & pilih kelas/subkelas dulu."); return; }

    // 🔍 Cek apakah nama sudah ada di database
    const votersSnap = await get(ref(db, "voters"));
    if (votersSnap.exists()) {
      const data = Object.values(votersSnap.val());
      const sudahAda = data.some(v => v.nama.toLowerCase() === nama.toLowerCase());
      if (sudahAda) {
        alert("Nama ini sudah digunakan untuk voting! Silakan gunakan nama lain.");
        return;
      }
    }

    currentUser = { nama, kelas, subkelas: subkelasValue };
    document.getElementById("formBox").style.display = 'none';
    document.getElementById("voteBox").style.display = 'block';
    renderCandidates();
  });

  document.getElementById("resetBtn").addEventListener('click', async () => {
    const code = document.getElementById("resetCode").value;
    if (code !== "271010") { alert("Kode reset salah!"); return; }
    if (!confirm("Yakin hapus semua data (votes, photos, voters)?")) return;
    await remove(ref(db, "votes"));
    await remove(ref(db, "photos"));
    await remove(ref(db, "voters"));
    alert("Semua data telah dihapus.");
    location.reload();
  });

  const unlockBtn = document.getElementById("unlockBtn");
  const lockBtn = document.getElementById("lockBtn");

  unlockBtn.addEventListener('click', () => {
    const code = document.getElementById("unlockCode").value.trim();
    if (code === "1937460501020304050607080910") {
      imageUnlocked = true;
      alert("Kunci gambar berhasil dibuka.");
      unlockBtn.style.display = "none";
      lockBtn.style.display = "inline-block";
      renderCandidates();
    } else {
      alert("Kode kunci salah!");
    }
  });

  lockBtn.addEventListener('click', () => {
    imageUnlocked = false;
    alert("Kunci gambar telah dikunci kembali.");
    unlockBtn.style.display = "inline-block";
    lockBtn.style.display = "none";
    renderCandidates();
  });

  (async function ensureInitialized(){
    const snap = await get(ref(db, "photos"));
    if (!snap.exists()){
      const emptyArr = Array(KANDIDAT.length).fill("");
      await set(ref(db, "photos"), emptyArr);
    }
  })();
</script>